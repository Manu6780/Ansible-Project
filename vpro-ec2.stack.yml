- name: setup Vprofie Stack
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Import VPC setup variables
      include_vars: Vars/output
    - name: import vprofile setup variables
      include_vars: Vars/vprofilestack
    - name: import VPC variable
      include_vars: Vars/VPC_vars

    - name: Create Key
      ec2_key:
        name: vprokey
        region: "{{region}}"
      register: keyout
    - name: copy key to a file
      copy:
        content: "{{keyout.key.private_key}}"
        dest: "./vprostack.pem"
        mode: 0600
      when: keyout.changed
    - name: Create security group for lb
      ec2_group:
        name: Vprolb-sg
        description: allow port 80 from anywhere
        region: "{{region}}"
        vpc_id: "{{vpcid}}"
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: 0.0.0.0/0
      register: Vprolb_sgout


    - name: Create security group for vprofile stack
      ec2_group:
        name: Vprostack-sg
        description: allow port 80 from anywhere
        region: "{{region}}"
        vpc_id: "{{vpcid}}"
        purge_rules: no
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            group_id: "{{Vprolb_sgout.group_id}}"

          - proto: tcp
            from_port: 22
            to_port: 22
            group_id: "{{BastionSGID}}"
      register: Vprostack_sgout
    - name: Create security group for vprofile stack
      ec2_group:
        name: Vprostack-sg
        description: allowed internal traffic
        region: "{{region}}"
        vpc_id: "{{vpcid}}"
        purge_rules: no
        rules:
          - proto: all
            group_id: "{{Vprostack_sgout.group_id}}"


